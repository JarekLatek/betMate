# Status implementacji widoku Mecze (Matches View)

## Status: ZAKOŃCZONY

Data zakończenia: 2025-12-08

---

## Podsumowanie

Widok "Mecze" stanowi ekran główny aplikacji (`/`). Umożliwia użytkownikom przeglądanie listy meczów w ramach wybranych turniejów oraz obstawianie ich wyników.

## Zaimplementowane funkcjonalności

### Podstawowe funkcje
- [x] Wybór turnieju z listy dropdown
- [x] Filtrowanie meczów (Nadchodzące / Zakończone)
- [x] Wyświetlanie listy meczów w formie kart
- [x] Obstawianie wyników (1/X/2)
- [x] Blokada obstawiania 5 minut przed meczem
- [x] Wyświetlanie wyników zakończonych meczów (wynik liczbowy np. 2:1)
- [x] Paginacja (przycisk "Załaduj więcej")
- [x] Toast notifications dla akcji użytkownika

### Obsługa stanów
- [x] Stan ładowania (spinner)
- [x] Stan błędu z przyciskiem "Spróbuj ponownie"
- [x] Stan pustej listy
- [x] Optimistic UI dla obstawiania

### Obsługa statusów meczów
- [x] SCHEDULED - możliwość obstawiania
- [x] IN_PLAY - zablokowane obstawianie
- [x] FINISHED - wyświetlanie wyniku i statusu zakładu
- [x] POSTPONED - komunikat "Mecz przełożony"
- [x] CANCELED - komunikat "Mecz odwołany"

---

## Struktura plików

### Komponenty React
| Plik | Opis |
|------|------|
| `src/components/matches/MatchesView.tsx` | Główny kontener widoku |
| `src/components/matches/TournamentSelector.tsx` | Dropdown wyboru turnieju |
| `src/components/matches/MatchListFilters.tsx` | Filtry Nadchodzące/Zakończone |
| `src/components/matches/MatchCard.tsx` | Karta pojedynczego meczu |
| `src/components/matches/BettingControls.tsx` | Przyciski obstawiania 1/X/2 |
| `src/components/matches/MatchResult.tsx` | Wyświetlanie wyniku meczu |

### Hooki
| Plik | Opis |
|------|------|
| `src/components/hooks/useMatches.ts` | Pobieranie meczów z paginacją |
| `src/components/hooks/useBetting.ts` | Logika obstawiania z optimistic UI |

### API Client
| Plik | Opis |
|------|------|
| `src/lib/api/matches.api.ts` | Frontend fetch wrappers |

### Komponenty UI (Shadcn)
| Plik | Opis |
|------|------|
| `src/components/ui/select.tsx` | Komponent Select |
| `src/components/ui/tabs.tsx` | Komponent Tabs |
| `src/components/ui/sonner.tsx` | Toast notifications |

### Strona Astro
| Plik | Opis |
|------|------|
| `src/pages/index.astro` | Strona główna z integracją MatchesView |

### Edge Function (Supabase)
| Plik | Opis |
|------|------|
| `supabase/functions/sync-matches/index.ts` | Synchronizacja danych (tryby: full/live) |

---

## Integracja API

### Wykorzystywane endpointy (wewnętrzne)
- `GET /api/tournaments` - lista turniejów
- `GET /api/matches` - lista meczów z filtrowaniem
- `POST /api/bets` - tworzenie nowego zakładu
- `PUT /api/bets/:id` - aktualizacja zakładu

### Parametry GET /api/matches
- `tournament_id` - ID turnieju
- `status` - SCHEDULED lub FINISHED
- `limit` - liczba wyników (domyślnie 20)
- `offset` - offset paginacji

### Integracja zewnętrzna (api-football.com)
- Edge Function `sync-matches` pobiera dane z api-football.com
- Obsługiwane turnieje: UEFA Champions League, UEFA Europa League
- Dwa tryby synchronizacji:
  - `full` (co 2-6h): pobiera tylko NOWE mecze (smart INSERT)
  - `live` (co 5-15 min): aktualizuje mecze IN_PLAY + rozpoczynające się
- Smart optimizations: pomija API call gdy brak meczów do aktualizacji

---

## Schemat bazy danych

### Tabela `matches`
| Kolumna | Typ | Opis |
|---------|-----|------|
| `id` | bigint | Primary key |
| `tournament_id` | bigint | FK do tournaments |
| `home_team` | text | Nazwa drużyny gospodarzy |
| `away_team` | text | Nazwa drużyny gości |
| `match_datetime` | timestamptz | Data i godzina meczu (UTC) |
| `status` | match_status | Status meczu |
| `result` | match_outcome | Typ wyniku (HOME_WIN/DRAW/AWAY_WIN) |
| `home_score` | smallint | Bramki gospodarzy |
| `away_score` | smallint | Bramki gości |
| `api_match_id` | bigint | ID z api-football.com |
| `is_scored` | boolean | Czy punkty zostały naliczone |

---

## Do rozważenia w przyszłości

- [ ] Infinite scroll zamiast przycisku "Załaduj więcej"
- [ ] Automatyczne odświeżanie listy meczów
- [ ] Countdown do zamknięcia obstawiania
- [ ] Konfiguracja dwóch cron schedules w produkcji: `full` (co 2-6h) + `live` (co 5-15 min)

---

## Testy

### Manualnie przetestowane scenariusze
- [x] Wybór turnieju
- [x] Przełączanie filtrów
- [x] Obstawianie meczu
- [x] Zmiana obstawionego wyniku
- [x] Blokada obstawiania przed meczem
- [x] Wyświetlanie wyników zakończonych meczów
- [x] Obsługa błędów API (nie testowalne lokalnie)
- [x] Paginacja

---

## Weryfikacja techniczna

- [x] TypeScript: Brak błędów (`npx tsc --noEmit`)
- [x] ESLint: Brak błędów (`npm run lint`)
- [x] Build: Sukces (`npm run build`)
