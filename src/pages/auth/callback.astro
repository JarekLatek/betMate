---
/**
 * Supabase Auth Callback Handler
 *
 * This page handles redirects from Supabase Auth:
 * - Email verification after registration
 * - Password reset link click
 *
 * The callback exchanges the authorization code for a session
 * and redirects to the appropriate page.
 */
export const prerender = false;

const { url } = Astro;
const code = url.searchParams.get("code");
const next = url.searchParams.get("next") ?? "/";
const type = url.searchParams.get("type");

if (code) {
  const { error } = await Astro.locals.supabase.auth.exchangeCodeForSession(code);

  if (!error) {
    // For password recovery, redirect to reset-password page
    if (type === "recovery") {
      return Astro.redirect("/reset-password");
    }
    // For other cases (email verification), redirect to next or home
    return Astro.redirect(next);
  }
}

// If no code or error occurred, redirect to login with error
return Astro.redirect("/login?error=auth_callback_error");
---
