---
import Layout from "../layouts/Layout.astro";
import { LogoutButton } from "@/components/auth/logout-button";
import { MatchesView } from "@/components/matches/MatchesView";
import { TournamentService } from "@/lib/services/tournament.service";
import type { TournamentDTO } from "@/types";

// Redirect unauthenticated users to login page
if (!Astro.locals.user) {
  return Astro.redirect("/login");
}

// Get user info for display
const username = Astro.locals.user.user_metadata?.username || Astro.locals.user.email;

// Fetch tournaments on the server
let tournaments: TournamentDTO[] = [];
try {
  const tournamentService = new TournamentService(Astro.locals.supabase);
  tournaments = await tournamentService.getAllTournaments();
} catch (error) {
  // eslint-disable-next-line no-console
  console.error("Error fetching tournaments:", error);
}
---

<Layout title="betMate - Mecze">
  <div class="bg-background min-h-screen">
    <!-- Top bar with user info -->
    <div class="border-b">
      <div class="container mx-auto flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-4">
          <img src="/betMate.svg" alt="betMate" class="h-8" />
          <nav class="flex items-center gap-2">
            <span class="text-sm font-medium">Mecze</span>
            <span class="text-muted-foreground">/</span>
            <a href="/my-bets" class="text-muted-foreground hover:text-foreground text-sm">Moje zak≈Çady</a>
            <span class="text-muted-foreground">/</span>
            <a href="/leaderboard" class="text-muted-foreground hover:text-foreground text-sm">Ranking</a>
          </nav>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-muted-foreground text-sm">{username}</span>
          <LogoutButton client:load />
        </div>
      </div>
    </div>

    <!-- Main matches view -->
    <MatchesView client:load initialTournaments={tournaments} />
  </div>
</Layout>
