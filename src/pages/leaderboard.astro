---
import Layout from "../layouts/Layout.astro";
import { LogoutButton } from "@/components/auth/logout-button";
import { LeaderboardView } from "@/components/leaderboard/LeaderboardView";
import { TournamentService } from "@/lib/services/tournament.service";
import type { TournamentDTO } from "@/types";

// Redirect unauthenticated users to login page
if (!Astro.locals.user) {
  return Astro.redirect("/login");
}

// Get user info for display
const username = Astro.locals.user.user_metadata?.username || Astro.locals.user.email;
const currentUserId = Astro.locals.user.id;

// Parse URL parameters for initial tournament selection
const url = new URL(Astro.request.url);
const tournamentIdParam = url.searchParams.get("tournamentId");
const initialTournamentId = tournamentIdParam ? Number(tournamentIdParam) : null;

// Fetch tournaments on the server
let tournaments: TournamentDTO[] = [];
try {
  const tournamentService = new TournamentService(Astro.locals.supabase);
  tournaments = await tournamentService.getAllTournaments();
} catch (error) {
  // eslint-disable-next-line no-console
  console.error("Error fetching tournaments:", error);
}
---

<Layout title="betMate - Ranking">
  <div class="bg-background min-h-screen">
    <!-- Top bar with user info -->
    <div class="border-b">
      <div class="container mx-auto flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-4">
          <a href="/" class="text-lg font-semibold hover:underline">betMate</a>
          <nav class="flex items-center gap-2">
            <a href="/" class="text-muted-foreground hover:text-foreground text-sm">Mecze</a>
            <span class="text-muted-foreground">/</span>
            <a href="/my-bets" class="text-muted-foreground hover:text-foreground text-sm">Moje zak≈Çady</a>
            <span class="text-muted-foreground">/</span>
            <span class="text-sm font-medium">Ranking</span>
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-muted-foreground text-sm">{username}</span>
          <LogoutButton client:load />
        </div>
      </div>
    </div>

    <!-- Main leaderboard view -->
    <LeaderboardView
      client:load
      initialTournaments={tournaments}
      initialTournamentId={initialTournamentId}
      currentUserId={currentUserId}
    />
  </div>
</Layout>
